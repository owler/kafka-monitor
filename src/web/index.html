<html>
<head>
    <title>
        Kafka monitor UI
    </title>
    <link href="css/style.css" rel="StyleSheet" type="text/css">
    <link href="source/styles/kendo.common.css" rel="stylesheet"/>
    <link href="source/styles/kendo.default.css" rel="stylesheet"/>
    <script src="source/jquery-1.7.1.js"></script>
    <script src="source/js/kendo.web.js"></script>
</head>
<body>
<div id="wrapper">
    <div id="header">
        <h1>Kafka monitor UI</h1>
    </div>
    <br/>
    <div id="content">
        <style scoped>

                #messageList, #gridTasks {
                border-collapse: separate;
                border-spacing: 0;
                font-size: 12px;
            }

            #messageList th, #gridTasks th, #showMessage th {
                padding: 6px 6px;
                color: #333;
                text-align: left;
                line-height: 14px;
                border-width: 0px;
                border-style: solid;
                border-color: #d75b26 #d75b26 #d75b26 #f28455;
                font-size: 12px;

            }

                   #showMessage td, #gridTasks td, #controls td{
                line-height: 23px;
                padding: 0 6px;
                color: #3d3d3d;
                border-width: 0px;
                border-style: solid;
                border-color: #f4f4f4 #d6d6d6 #d6d6d6 #f4f4f4;
                font-size: 12px;
            }

            #messageList td {
                line-height: 23px;
                padding: 0 6px;
                color: #3d3d3d;
                border-width: 0px;
                border-style: solid;
                border-color: #f4f4f4 #d6d6d6 #d6d6d6 #f4f4f4;
                font-size: 12px;
                                overflow:hidden; text-overflow: ellipsis; white-space:nowrap;
                                }
        </style>

        <table border="0">
            <tr valign="top">
                <td rowspan="2">
                    <div id="gridTasks" style="width: 420px;height:800px"></div>
                </td>
                <td>
                    <table id="controls" border="0">
                        <tr><td>&nbsp;</td><td>topic</td><td>Partition</td><td>Start</td><td>Selected</td><td>type</td></tr>
                        <tr>
                            <td>
                                <button id="submit" onclick="search()"/>
                                Search
                            </td>
                            <td>
                                <input id="topic2search" style="width:250px;"/>
                            </td>
                            <td>
                                <input id="partition2search" style="width:50px;"/>
                            </td>

                            <td>
                                <input id="offset2search" style="width:150px;"/>
                            </td>
                            <td><input id="selectedOffset2search" style='width:150px;'/>
                            </td>
                            <td>
                                <select id="messageTypeComboBox">
                                    <option>Bytes</option>
                                    <option>RFG</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="6" >
                                <div id="messageList" ></div>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
                <td>
                    <div id="showMessage" style="height:500px;">
                    </div>
                </td>
            </tr>
        </table>
        <script>

            var transport = {
                read: {
                    url: "http://localhost:8877/topic/list",
                    dataType: "jsonp",
                    jsonp: "callback",
                    cache: false
                }
            };

            var transportDetails = {
                read: {
                    url: "http://localhost:8877/topic/details",
                    dataType: "jsonp",
                    jsonp: "callback",
                    cache: false
                }
            };

            var transportForMessage = {
                read:{
                    url: function(data) {
                    return  "http://localhost:8877/topic/" +$("#topic2search").val() + "/partition/" + $("#partition2search").val() + "/offset/" + $("#offset2search").val() + "/limit/10";
                    },
                dataType:"jsonp",
                cache:false,
                jsonp: "callback"
                }
            };

            var transport2ForMessage = {
                read:{
                    url: function(data) {
                    return  "http://localhost:8877/topic/" +$("#topic2search").val() + "/partition/" + $("#partition2search").val() + "/offset/" + $("#selectedOffset2search").val();
                    },
                dataType:"jsonp",
                cache:false,
                jsonp: "callback"
                }
            };


            var tasksDataSource = new kendo.data.DataSource({
                transport: transport,
                //data: data,
                schema: {
                    data: "topics"
                }
            });

            var messageDataSource = new kendo.data.DataSource({
                transport: transportForMessage,
                //data: data,
                schema: {
                    data: "messages"
                }
            });

            var message2DataSource = new kendo.data.DataSource({
                transport: transport2ForMessage,
                //data: data,
                schema: {
                    data: "messages"
                }

            });



            function createGrid() {
                $("#gridTasks").kendoGrid({
                    columns:[
                        {title: "Topic name", field: "topic"}
                    ],
                    scrollable: true,
                    dataSource: tasksDataSource,
                    detailInit: detailInit,
                    dataBound: function() {
                     // this.expandRow(this.tbody.find("tr.k-master-row").first());
                    },
                });
            }

            function createMessageGrid() {
                $("#messageList").kendoGrid({
                    columns:[
                        {title:"Offset", template:"<span>#= offset #</span><span style='display: none' id='offsetId'>#= offset #</span>"},
                        {title: "Timestamp", field: "timestamp"},
                        {title: "Message", field: "message"}
                    ],
                    scrollable: true,
                    dataSource: messageDataSource,
                                    dataBound:  injectMessageRowEvent
                });
            }


            $(document).ready(function() {
                        createGrid();
            });

            function injectMessageRowEvent() {
                var tr = $('#messageList').data("kendoGrid").tbody.find(">tr");
                tr.click(function (e) {
                                                var topic = $("#topic2search").val;
                                        var partition = $("#partition2search").val;
                                        var offset = $(this).find('#offsetId').text();
                                                $("#selectedOffset2search").val(offset);
                                                createShowGrid();
                        message2DataSource.read();
                });
                tr.mouseover(function () {
                    $(this).css("background-color", "#9BBB38");
                });
                tr.mouseout(function () {
                    $(this).css("background-color", "");
                });
            }

            function createShowGrid() {
                $("#showMessage").kendoGrid({
                    columns:[
                        {title: "Message", field: "message"}
                    ],
                    scrollable: true,
                    dataSource: message2DataSource
                });
            }


            function injectDetailRowEvent() {
                var tr = $('.k-detail-cell tbody tr');
                tr.click(function () {
                    var  id = $(this).find('#id').text().split(":");
                            $("#topic2search").val(id[0]);
                            $("#partition2search").val(id[1]);
                            $("#offset2search").val(id[2]);

                });
                tr.mouseover(function () {
                    $(this).css("background-color", "#9BBB38");
                });
                tr.mouseout(function () {
                    $(this).css("background-color", "");
                });
            }

            function detailInit(e) {
                $("<div/>").appendTo(e.detailCell).kendoGrid({
                    dataSource: {
                        type: "jsonp",
                        transport: transportDetails,
                    schema: {
                        data: "partitions"
                    },

                        serverPaging: false,
                        serverSorting: false,
                        serverFiltering: true,
                        filter: { field: "topic", operator: "eq", value: e.data.topic }
                    },
                    scrollable: false,
                    sortable: true,
                    pageable: false,
                    columns: [
                        { title:"partition", width:27, template:"<span>#= partition #</span><span style='display: none' id='id'>#= topic #:#= partition #:#= start #</span>"},
                        { field: "start", title:"Start", width: "50px" },
                        { field: "end", title:"End", width:"50px" }
                    ],
                    dataBound:injectDetailRowEvent
                });
            }

            function search(e) {
                createMessageGrid();
                messageDataSource.read();
            }
    </script>
    </div>
</div>
</body>
</html>