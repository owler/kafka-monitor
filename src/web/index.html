<html>
<head>
    <title>
        Kafka monitor UI
    </title>
    <link href="css/style.css" rel="StyleSheet" type="text/css">
    <link href="source/styles/kendo.common.css" rel="stylesheet"/>
    <link href="source/styles/kendo.default.css" rel="stylesheet"/>
    <script src="source/jquery-1.7.1.js"></script>
    <script src="source/js/kendo.web.js"></script>
</head>
<body>
<div id="wrapper">
    <div id="header">
        <h1>Kafka monitor UI</h1>
    </div>
    <br/>
    <div id="content">
        <style scoped>

            #messageList, #gridTasks {
                border-collapse: separate;
                border-spacing: 0;
                font-size: 12px;
            }

            #messageList th, #gridTasks th {
                padding: 6px 6px;
                color: #333;
                text-align: left;
               line-height: 14px;
                border-width: 0px;
                border-style: solid;
                border-color: #d75b26 #d75b26 #d75b26 #f28455;
                font-size: 12px;

            }

            #gridTasks td, #controls td{
                line-height: 23px;
                padding: 0 6px;
                color: #0d2d2d;
                border-width: 0px;
                border-style: solid;
                border-color: #f4f4f4 #d6d6d6 #d6d6d6 #f4f4f4;
                font-size: 12px;
            }

            #showMessage {
                white-space:pre;
                color: #002200;
                font-size: 12px;
                font-weight: bold;
                overflow:scroll; text-overflow: string;
            }

            #messageList td {
                line-height: 23px;
                padding: 0 6px;
                color: #0d1d1d;
                border-width: 0px;
                border-style: solid;
                border-color: #f4f4f4 #d6d6d6 #d6d6d6 #f4f4f4;
                font-size: 12px;
                overflow:hidden; text-overflow: ellipsis; white-space:nowrap;
            }
            a.a_download:hover {
                background-color: #9BBB38;
                color: blue;
                cursor:pointer;
            }
            a.a_download {
                text-decoration: underline;
            }

        </style>
        <table border="0">
            <tr>
                <td rowspan="3" valign="top">
                    <div id="gridTasks" style="width: 420px;height:800px;"></div>
                </td>
                <td rowspan="3">
                    &nbsp;
                </td>

                <td>
                    <table id="controls" border="0">
                        <tr><td>&nbsp;</td><td>topic</td><td>partition</td><td>start from</td><td>selected offset</td><td>type</td><td style="width:100%"></td></tr>
                        <tr>
                            <td>
                                <button id="submit" onclick="search()">Search</button>
                            </td>
                            <td>
                                <input id="topic2search" style="width:370px;" value=" " disabled/>
                            </td>
                            <td>
                                <input id="partition2search" style="width:50px;" value="0" disabled/>
                            </td>

                            <td>
                                <input id="offset2search" style="width:150px;" value="0" onkeyup="key_up(event)"/>
                            </td>
                            <td><input id="selectedOffset2search" style="width:150px;" value="0" disabled/>
                            </td>
                            <td>
                                <select id="messageTypeComboBox">
                                    <option>UTF8</option>
                                </select>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr >
                <td><div style="height:750px; width:1350px;">
                    <div id="messageList" ></div><br/>
                    <div id="messageInfo" style="width:100%;background-color: #e3e3e3e3; color:#333;font-size: 12px; text-align:right;"></div>
                    <div id="showMessage" style="width:100%;"></div>
                </div>
                </td>
            </tr>
        </table>

        <script>
            function key_up(e){
                var enterKey = 13; //Key Code for Enter Key
                if (e.which == enterKey){
                    search();
                }
            }

            var transportMsgTypes = {
               read: {
                    url: "/topic/msgtypes",
                    dataType: "jsonp",
                    jsonp: "callback",
                    cache: false
                }
            };

            var transport = {
                read: {
                    url: "/topic/list",
                    dataType: "jsonp",
                    jsonp: "callback",
                    cache: false
                }
            };

            var transportDetails = {
                read: {
                    url: "/topic/details",
                    dataType: "jsonp",
                    jsonp: "callback",
                    cache: false
                }
            };

            var transportForMessage = {
                read:{
                    url: function(data) {
                        return  "/topic/" +$("#topic2search").val()
                            + "/partition/" + $("#partition2search").val()
                            + "/offset/" + $("#offset2search").val()
                            + "/msgtype/" + $("#messageTypeComboBox").val()
                            + "/limit/10";
                    },
                   dataType:"jsonp",
                    cache:false,
                    jsonp: "callback"
                }
            };

            var transport2ForMessage = {
                read:{
                    url: function(data) {
                        return  "/topic/" + $("#topic2search").val()
                            + "/partition/" + $("#partition2search").val()
                            + "/offset/" + $("#selectedOffset2search").val()
                            + "/msgtype/" + $("#messageTypeComboBox").val();
                    },
                    dataType:"jsonp",
                    cache:false,
                    jsonp: "callback"
                }
            };


            var tasksDataSource = new kendo.data.DataSource({
                transport: transport,
                //data: data,
                schema: {
                    data: "topics"
                }
            });

            var messageDataSource = new kendo.data.DataSource({
                transport: transportForMessage,
                //data: data,
                schema: {
                    data: "messages"
                }
            });

            var message2DataSource = new kendo.data.DataSource({
                transport: transport2ForMessage,
                //data: data,
                schema: {
                    data: "messages"
                },
               change: function(e) {
                       var data = this.data();
                       if (data.length > 0) {
                            var info = "topic: " + $("#topic2search").val()
                            + " partition: " + $("#partition2search").val()
                            + " offset: " + $("#selectedOffset2search").val()
                            + " msgtype: " + $("#messageTypeComboBox").val();
                            $("#messageInfo").text(info);
                            $("#showMessage").text(data[0].message);
                       }
               }
            });


            var msgTypeDataSource = new kendo.data.DataSource({
                transport: transportMsgTypes,
                //data: data,
                schema: {
                    data: "msgtypes"
                }
            });


            function createGrid() {
                $("#gridTasks").kendoGrid({
                    columns:[
                        {title: "Topics", field: "topic"}
                    ],
                    scrollable: true,
                    filterable: true,
                    dataSource: tasksDataSource,
                    detailInit: detailInit,
                    dataBound: function() {
                        // this.expandRow(this.tbody.find("tr.k-master-row").first());
                    },
                });
            }

            function downloadMsg(id) {
                return  "/topic/" + $("#topic2search").val()
                    + "/partition/" + $("#partition2search").val()
                    + "/offset/" + id
                    + "/download";
            }
            function downloadMsgForType(id, msgType) {
                return  "/topic/" + $("#topic2search").val()
                    + "/partition/" + $("#partition2search").val()
                    + "/offset/" + id
                    + "/msgtype/" + msgType
                    + "/download";
            }
            function createMessageGrid() {
                $("#messageList").kendoGrid({
                    columns:[
                        {title: "Offset", width:70, template:"<span>#= offset #</span><span style='display: none' id='offsetId'>#= offset #</span>"},
                        {title: "Timestamp", width:220, field: "timestamp"},
                        {title: "Message", field: "message", width:"100%"},
                        {title: "byte[]", width:90, template:"<a class='a_download' onclick='location.href=downloadMsg(#= offset #)'>#= Math.round(size/100)/10 # Kb</a>"},
                        {title: "Download", width:130, template:"#= msgtype #:<a class='a_download' onclick='location.href=downloadMsgForType(#= offset # , \"#= msgtype #\")'>#= Math.round(msgsize/100)/10 # Kb</a>"}
                    ],
                    scrollable: true,
                    dataSource: messageDataSource,
                    dataBound:  injectMessageRowEvent
                });
            }

            function initControls() {
             $("#messageTypeComboBox").kendoDropDownList({
                        dataTextField: "msgtype",
                        dataValueField: "msgtype",
                        dataSource: msgTypeDataSource,
                        change: function(e) {
                           search();
                        }
                    });
            }

            $(document).ready(function() {
                initControls();
                createGrid();
                createMessageGrid();
            });

            function injectMessageRowEvent() {
                var tr = $('#messageList').data("kendoGrid").tbody.find(">tr");
                tr.click(function (e) {
                    var topic = $("#topic2search").val;
                    var partition = $("#partition2search").val;
                    var offset = $(this).find('#offsetId').text();
                    $("#selectedOffset2search").val(offset);
                    message2DataSource.read();
                });
                tr.mouseover(function () {
                    $(this).css("background-color", "#9BBB38");
                });
                tr.mouseout(function () {
                    $(this).css("background-color", "");
                });
            }

            function injectDetailRowEvent() {
                var tr = $('.k-detail-cell tbody tr');
                tr.click(function () {
                    var  id = $(this).find('#id').text().split(":");
                    $("#topic2search").val(id[0]);
                    $("#partition2search").val(id[1]);
                    $("#offset2search").val(id[2]);
                    $("#selectedOffset2search").val(id[2]);
                    $("#showMessage").empty();
                    search();
                });
                tr.mouseover(function () {
                    $(this).css("background-color", "#9BBB38");
                });
               tr.mouseout(function () {
                    $(this).css("background-color", "");
                });
            }

            function detailInit(e) {
                $("<div/>").appendTo(e.detailCell).kendoGrid({
                    dataSource: {
                        type: "jsonp",
                        transport: transportDetails,
                        schema: {
                           data: "partitions"
                        },

                        serverPaging: false,
                        serverSorting: false,
                        serverFiltering: true,
                        filter: { field: "topic", operator: "eq", value: e.data.topic }
                    },
                    scrollable: false,
                    sortable: true,
                    pageable: false,
                    columns: [
                        { title: "partition", width:27, template:"<span>#= partition #</span><span style='display: none' id='id'>#= topic #:#= partition #:#= start #</span>"},
                        { field: "start", title:"start offset", width: "50px" },
                        { field: "end", title:"end offset", width:"50px" }
                    ],
                    dataBound:injectDetailRowEvent
                });
            }

            function search(e) {
                var offset = $("#offset2search").val();
                var offsetVal = parseInt(offset);
                if(!isNaN(offsetVal)) {
                    $("#offset2search").val(offsetVal)
                    var selectedOffset = $("#selectedOffset2search").val();
                    if (parseInt(selectedOffset) < offsetVal) {
                        $("#selectedOffset2search").val(offsetVal)
                    }
                    messageDataSource.read();
                    message2DataSource.read();
                } else {
                    alert("Wrong input for start offset " + offset + ". Expected Int value");
                }
            }
        </script>
    </div>
</div>
</body>
</html>
